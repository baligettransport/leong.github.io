<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BGT-PRO - Portal Anggota</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --gray: #64748b;
            --gray-light: #94a3b8;
            --white: #ffffff;
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow-x: hidden; }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(180deg, #E0F7FA 0%, #FFFFFF 100%); 
            color: var(--dark); 
            min-height: 100dvh; 
        }

        /* CSS UNTUK MENYEMBUNYIKAN SCROLLBAR */
        html, body, .app-container {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE dan Edge */
        }
        html::-webkit-scrollbar, body::-webkit-scrollbar, .app-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        #bg-video { display: none; }
        .video-overlay { display: none; }

        .app-container { width: 100%; min-height: 100dvh; padding-bottom: 90px; overflow-y: auto; padding-top: 60px; /* Padding top agar konten tidak tertutup header fixed */ }

        /* Header - FIXED */
        .header { 
            position: fixed; /* Diubah menjadi fixed */
            top: 0; 
            left: 0;
            width: 100%;
            z-index: 100; 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(15px); 
            padding: 10px 16px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid rgba(0,0,0,0.05); 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        
        .header-profile { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .header-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(0,0,0,0.1); }
        .header-user-info { display: flex; flex-direction: column; }
        .header-name { font-size: 0.9rem; font-weight: 600; line-height: 1.1; color: var(--dark); }
        .header-status { font-size: 0.7rem; color: var(--success); display: flex; align-items: center; gap: 4px; }
        .header-status .status-dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; }

        .header-right { display: flex; align-items: center; gap: 8px; }
        
        /* Tombol Notifikasi & Bantuan - Tanpa Background */
        .notif-btn { 
            width: 38px; height: 38px; 
            background: transparent;
            border: none; 
            border-radius: 10px; 
            color: var(--dark); font-size: 1.1rem; cursor: pointer; 
            position: relative; 
            display: flex; align-items: center; justify-content: center; 
            text-decoration: none; 
            transition: opacity 0.2s;
        }
        .notif-btn:active { opacity: 0.6; }
        
        .notif-badge { position: absolute; top: 2px; right: 2px; min-width: 16px; height: 16px; background: var(--danger); border-radius: 50%; font-size: 0.6rem; font-weight: 700; display: flex; align-items: center; justify-content: center; color: white; }
        .notif-badge.hidden { display: none; }

        /* Section Header */
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 0 16px; margin-bottom: 12px; margin-top: 10px; }
        .section-title { font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; color: var(--dark); text-shadow: none; }
        .section-title i { color: var(--primary); }
        .section-link { font-size: 0.8rem; color: var(--primary); text-decoration: none; font-weight: 500; cursor: pointer; }

        /* Feature Menu - Icon Only */
        .feature-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin: 0 16px 20px; }
        .feature-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; text-decoration: none; color: inherit; }
        .feature-icon { 
            width: 55px; height: 55px; 
            background: transparent;
            border: none;
            border-radius: 14px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.8rem; 
            transition: all 0.3s; 
            text-shadow: none;
        }
        .feature-item:active .feature-icon { transform: scale(0.9); opacity: 0.8; }
        .feature-icon.kopdar { color: #ec4899; }
        .feature-icon.promo { color: #f59e0b; }
        .feature-icon.location { color: #10b981; }
        .feature-icon.chat { color: #3b82f6; }
        .feature-icon.history { color: #f97316; }
        .feature-icon.kas { color: #eab308; }
        .feature-icon.anggota { color: #0ea5e9; }
        .feature-icon.share { color: #ef4444; }
        .feature-label { font-size: 0.7rem; color: var(--gray); text-align: center; font-weight: 500; text-shadow: none; }

        /* Promo Slider */
        .promo-slider-wrapper { margin: 16px 0 20px; overflow: hidden; }
        .promo-slider { display: flex; gap: 12px; padding: 0 16px; animation: autoScroll 20s linear infinite; }
        .promo-slider:hover { animation-play-state: paused; }
        @keyframes autoScroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        
        .promo-card { 
            min-width: 280px; height: 160px; border-radius: 18px; padding: 16px; 
            position: relative; overflow: hidden; flex-shrink: 0; cursor: pointer;
            background: linear-gradient(135deg, #e2e8f0 0%, #f1f5f9 100%);
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            color: var(--dark);
        }
        .promo-card.promo-1 { background: linear-gradient(135deg, #cffafe 0%, #e0f2fe 100%); }
        .promo-card.promo-2 { background: linear-gradient(135deg, #fce7f3 0%, #fdf2f8 100%); }
        .promo-card.promo-3 { background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%); }
        .promo-card.promo-4 { background: linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%); }

        .promo-card:active { transform: scale(0.98); }
        .promo-card::before { content: ''; position: absolute; top: -25%; right: -8%; width: 120px; height: 120px; background: rgba(255,255,255,0.6); border-radius: 50%; }
        .promo-image { position: absolute; right: 12px; bottom: 12px; width: 85px; height: 85px; border-radius: 12px; object-fit: cover; opacity: 0.9; border: 2px solid #fff; }
        .promo-badge { display: inline-block; background: var(--primary); color: white; padding: 3px 10px; border-radius: 9999px; font-size: 0.65rem; font-weight: 600; margin-bottom: 8px; }
        .promo-title { font-size: 1.05rem; font-weight: 700; margin-bottom: 4px; max-width: 160px; color: var(--dark); }
        .promo-desc { font-size: 0.8rem; color: var(--gray); max-width: 150px; line-height: 1.3; }

        /* Kopdar */
        .kopdar-list { margin: 0 16px 20px; }
        .kopdar-card { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(5px);
            border-radius: 16px; padding: 12px; margin-bottom: 10px; 
            display: flex; gap: 12px; 
            border: 1px solid rgba(0,0,0,0.05); 
            cursor: pointer; transition: all 0.3s; 
            text-decoration: none; color: inherit; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        }
        .kopdar-card:active { border-color: var(--primary); transform: scale(0.99); }
        .kopdar-image { width: 75px; height: 75px; border-radius: 10px; object-fit: cover; flex-shrink: 0; }
        .kopdar-info { flex: 1; }
        .kopdar-title { font-weight: 600; margin-bottom: 4px; font-size: 0.95rem; color: var(--dark); }
        .kopdar-meta { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 6px; }
        .kopdar-meta span { display: flex; align-items: center; gap: 4px; font-size: 0.75rem; color: var(--gray); }
        .kopdar-meta i { font-size: 0.7rem; color: var(--primary); }
        .kopdar-badge { display: inline-block; background: rgba(99, 102, 241, 0.1); color: var(--primary); padding: 3px 8px; border-radius: 9999px; font-size: 0.65rem; font-weight: 600; }
        .kopdar-badge.soon { background: rgba(245, 158, 11, 0.1); color: var(--accent); }
        .kopdar-badge.open { background: rgba(16, 185, 129, 0.1); color: var(--success); }

        /* BOTTOM NAV */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #ffffff;
            display: flex; align-items: center; 
            border-top: 1px solid rgba(0,0,0,0.05); 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 100; height: 70px; padding: 0 10px;
        }

        .nav-item { 
            display: flex; flex-direction: column; align-items: center; gap: 3px; 
            padding: 6px 12px; border-radius: 10px; cursor: pointer; 
            color: var(--gray);
            text-decoration: none; transition: all 0.3s; 
        }
        .nav-item.active { 
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            font-weight: bold; 
        }
        .nav-item:active { transform: scale(0.95); }
        .nav-item i { font-size: 1.15rem; }
        .nav-item span { font-size: 0.65rem; font-weight: 500; }

        .nav-branda { order: 1; margin-left: -15px; }
        .nav-kopdar { order: 2; margin-right: 70px; margin-left: 15px; }

        .nav-logo {
            position: absolute; left: 49%; bottom: 8px; transform: translateX(-50%);
            z-index: 101; order: 10; width: 100px; top: -15px;
            background: transparent;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 0px; transition: transform 0.2s; cursor: pointer; text-decoration: none;
        }
        .nav-logo:active { transform: translateX(-50%) scale(0.9); }
        .nav-logo img { width: 45px; height: 45px; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .nav-logo-text {
            font-size: 0.65rem; font-weight: 700; color: var(--primary);
            letter-spacing: 0.5px; text-transform: uppercase; line-height: 1; margin-top: 1px;
        }

        .nav-promo { order: 4; margin-left: auto; margin-right: 26px; }
        .nav-profil { order: 5; margin-right: 5px; }

        /* Side Menu */
        .side-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background: rgba(0,0,0,0.2); z-index: 200; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .side-menu-overlay.active { opacity: 1; visibility: visible; }
        .side-menu { position: fixed; top: 0; left: -280px; width: 280px; height: 100dvh; background: #ffffff; z-index: 201; transition: left 0.3s ease; overflow-y: auto; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        .side-menu.active { left: 0; }
        .menu-header { padding: 25px 18px; background: var(--gradient-primary); position: relative; overflow: hidden; }
        .menu-header::before { content: ''; position: absolute; top: -40%; right: -25%; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; }
        .menu-profile { display: flex; align-items: center; gap: 12px; position: relative; z-index: 1; }
        .menu-avatar { width: 55px; height: 55px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.3); object-fit: cover; }
        .menu-name { font-weight: 700; font-size: 1rem; color: white; }
        .menu-title { font-size: 0.8rem; opacity: 0.9; color: white; }
        .menu-close { position: absolute; top: 15px; right: 12px; width: 32px; height: 32px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; color: white; font-size: 0.9rem; cursor: pointer; }
        .menu-items { padding: 15px 0; }
        .menu-section { padding: 10px 18px; font-size: 0.7rem; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .menu-link { display: flex; align-items: center; gap: 12px; padding: 12px 18px; color: var(--dark); text-decoration: none; cursor: pointer; transition: all 0.3s; }
        .menu-link:active { background: rgba(0,0,0,0.05); }
        .menu-link i { width: 18px; text-align: center; color: var(--primary); font-size: 0.95rem; }
        .menu-link span { flex: 1; font-size: 0.9rem; }
        .menu-link .arrow { color: var(--gray); font-size: 0.7rem; }

        /* Toast */
        .toast-container { position: fixed; top: 70px; right: 12px; left: 12px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
        .toast { background: #ffffff; border: 1px solid rgba(0,0,0,0.05); border-radius: 12px; padding: 12px 14px; display: flex; align-items: flex-start; gap: 10px; animation: slideIn 0.3s ease; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); pointer-events: auto; color: var(--dark); }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast.hiding { animation: slideOut 0.3s ease forwards; }
        @keyframes slideOut { to { transform: translateY(-20px); opacity: 0; } }
        .toast-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
        .toast-icon.success { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .toast-icon.info { background: rgba(99, 102, 241, 0.15); color: var(--primary); }
        .toast-icon.warning { background: rgba(245, 158, 11, 0.15); color: var(--accent); }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 600; font-size: 0.85rem; margin-bottom: 2px; }
        .toast-message { font-size: 0.75rem; color: var(--gray); }
        .toast-close { background: none; border: none; color: var(--gray); cursor: pointer; padding: 4px; font-size: 0.8rem; }

        /* ============================================
           KEAMANAN: SESSION KICK OVERLAY
           ============================================ */
        .session-kick-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.98);
            z-index: 99999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
        }

        .session-kick-overlay.active {
            display: flex;
        }

        .kick-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #f59e0b, #e67e22);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1.5rem;
            animation: shakeIcon 0.5s ease-in-out;
            box-shadow: 0 0 40px rgba(245, 158, 11, 0.4);
        }

        .kick-icon i {
            font-size: 3rem;
            color: #fff;
        }

        .kick-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 1rem;
            text-align: center;
        }

        .kick-message {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            max-width: 300px;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .kick-device-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .kick-device-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            margin: 0.3rem 0;
        }

        .kick-device-info strong {
            color: #f59e0b;
        }

        .btn-kick-ok {
            padding: 0.9rem 2.5rem;
            background: linear-gradient(135deg, #f59e0b, #e67e22);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(243, 156, 18, 0.4);
        }

        .btn-kick-ok:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(243, 156, 18, 0.5);
        }

        @keyframes shakeIcon {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }

        /* ============================================
           KEAMANAN: PERMISSION REQUEST OVERLAY
           ============================================ */
        .permission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #E0F7FA 0%, #FFFFFF 100%);
            z-index: 100000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .permission-overlay.active {
            display: flex;
        }

        .permission-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .permission-header .shield-icon {
            width: 100px;
            height: 100px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 1.5rem;
            animation: pulseShield 2s ease-in-out infinite;
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.4);
        }

        .permission-header .shield-icon i {
            font-size: 3rem;
            color: #fff;
        }

        .permission-header h2 {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .permission-header p {
            font-size: 0.9rem;
            color: var(--gray);
            max-width: 300px;
            line-height: 1.5;
        }

        .permission-list {
            width: 100%;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .permission-item {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 14px;
            padding: 0.9rem;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .permission-item.granted {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.08);
        }

        .permission-item.denied {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.08);
        }

        .permission-item.current {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.08);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
        }

        .permission-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .permission-item[data-type="camera"] .permission-icon {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .permission-item[data-type="contacts"] .permission-icon {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .permission-item[data-type="location"] .permission-icon {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .permission-item[data-type="microphone"] .permission-icon {
            background: linear-gradient(135deg, #1abc9c, #16a085);
        }

        .permission-item[data-type="notifications"] .permission-icon {
            background: linear-gradient(135deg, #f39c12, #d68910);
        }

        .permission-item[data-type="bluetooth"] .permission-icon {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .permission-item[data-type="phone"] .permission-icon {
            background: linear-gradient(135deg, #27ae60, #1e8449);
        }

        .permission-item[data-type="photos"] .permission-icon {
            background: linear-gradient(135deg, #e91e63, #c2185b);
        }

        .permission-icon i {
            color: #fff;
        }

        .permission-info {
            flex: 1;
        }

        .permission-info h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 2px;
        }

        .permission-info p {
            font-size: 0.7rem;
            color: var(--gray);
        }

        .permission-status {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
        }

        .permission-status.waiting {
            background: #f39c12;
        }

        .permission-status.waiting i {
            color: #fff;
        }

        .permission-status.granted {
            background: var(--success);
        }

        .permission-status.granted i {
            color: #fff;
        }

        .permission-status.denied {
            background: var(--danger);
        }

        .permission-status.denied i {
            color: #fff;
        }

        .permission-status.loading {
            background: var(--primary);
            animation: spin 1s linear infinite;
        }

        .permission-progress {
            width: 100%;
            max-width: 380px;
            margin-bottom: 1.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 8px;
        }

        .permission-buttons {
            width: 100%;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-permission {
            width: 100%;
            padding: 0.9rem;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-permission:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-permission:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-permission.success {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .btn-permission.danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
        }

        .btn-settings {
            width: 100%;
            padding: 0.8rem;
            background: rgba(0, 0, 0, 0.05);
            color: var(--dark);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 14px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-settings:hover {
            background: rgba(0, 0, 0, 0.08);
        }

        .btn-settings.show {
            display: flex;
        }

        .permission-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            max-width: 380px;
            width: 100%;
            display: none;
        }

        .permission-warning.show {
            display: block;
        }

        .permission-warning p {
            color: var(--danger);
            font-size: 0.8rem;
            text-align: center;
            line-height: 1.5;
        }

        .permission-warning p i {
            margin-right: 5px;
        }

        @keyframes pulseShield {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(99, 102, 241, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 50px rgba(99, 102, 241, 0.6); }
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <video id="bg-video" autoplay loop playsinline muted>
        <source src="VideoBgt.mp4" type="video/mp4">
    </video>
    <div class="video-overlay"></div>

    <div class="toast-container" id="toastContainer"></div>

    <!-- KEAMANAN: SESSION KICK OVERLAY -->
    <div id="sessionKickOverlay" class="session-kick-overlay">
        <div class="kick-icon">
            <i class="fas fa-sign-out-alt"></i>
        </div>
        <h2 class="kick-title">SESI ANDA BERAKHIR</h2>
        <p class="kick-message">Akun Anda telah login di perangkat lain. Hanya satu perangkat yang dapat mengakses akun pada satu waktu.</p>
        <div class="kick-device-info">
            <p><i class="fas fa-mobile-alt"></i> <strong>Login Baru Terdeteksi</strong></p>
            <p id="kickDeviceInfo">Perangkat lain</p>
        </div>
        <button class="btn-kick-ok" onclick="handleSessionKick()">
            <i class="fas fa-check"></i> Mengerti
        </button>
    </div>

    <!-- KEAMANAN: PERMISSION REQUEST OVERLAY -->
    <div id="permissionOverlay" class="permission-overlay">
        <div class="permission-header">
            <div class="shield-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h2>Izin Perangkat</h2>
            <p>Pastikan semua izin sudah aktif di pengaturan HP Anda</p>
        </div>

        <div class="permission-progress">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressFill"></div>
            </div>
            <p class="progress-text" id="progressText">Memeriksa izin...</p>
        </div>

        <div class="permission-list">
            <!-- Kamera -->
            <div class="permission-item" data-type="camera" data-permission="camera">
                <div class="permission-icon">
                    <i class="fas fa-camera"></i>
                </div>
                <div class="permission-info">
                    <h4>Kamera</h4>
                    <p>Untuk foto profil dan verifikasi</p>
                </div>
                <div class="permission-status waiting" id="status-camera">
                    <i class="fas fa-clock"></i>
                </div>
            </div>

            <!-- Kontak -->
            <div class="permission-item" data-type="contacts" data-permission="contacts">
                <div class="permission-icon">
                    <i class="fas fa-address-book"></i>
                </div>
                <div class="permission-info">
                    <h4>Kontak</h4>
                    <p>Untuk komunikasi anggota</p>
                </div>
                <div class="permission-status waiting" id="status-contacts">
                    <i class="fas fa-clock"></i>
                </div>
            </div>

            <!-- Lokasi -->
            <div class="permission-item" data-type="location" data-permission="location">
                <div class="permission-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="permission-info">
                    <h4>Lokasi</h4>
                    <p>Untuk tracking dan navigasi</p>
                </div>
                <div class="permission-status waiting" id="status-location">
                    <i class="fas fa-clock"></i>
                </div>
            </div>

            <!-- Mikrofon -->
            <div class="permission-item" data-type="microphone" data-permission="microphone">
                <div class="permission-icon">
                    <i class="fas fa-microphone"></i>
                </div>
                <div class="permission-info">
                    <h4>Mikrofon</h4>
                    <p>Untuk panggilan suara</p>
                </div>
                <div class="permission-status waiting" id="status-microphone">
                    <i class="fas fa-clock"></i>
                </div>
            </div>

            <!-- Notifikasi -->
            <div class="permission-item" data-type="notifications" data-permission="notifications">
                <div class="permission-icon">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="permission-info">
                    <h4>Notifikasi</h4>
                    <p>Untuk informasi penting</p>
                </div>
                <div class="permission-status waiting" id="status-notifications">
                    <i class="fas fa-clock"></i>
                </div>
            </div>

            <!-- Perangkat di Sekitar (Bluetooth) -->
            <div class="permission-item" data-type="bluetooth" data-permission="bluetooth">
                <div class="permission-icon">
                    <i class="fas fa-broadcast-tower"></i>
                </div>
                <div class="permission-info">
                    <h4>Perangkat di Sekitar</h4>
                    <p>Untuk koneksi bluetooth</p>
                </div>
                <div class="permission-status waiting" id="status-bluetooth">
                    <i class="fas fa-clock"></i>
                </div>
            </div>

            <!-- Ponsel -->
            <div class="permission-item" data-type="phone" data-permission="phone">
                <div class="permission-icon">
                    <i class="fas fa-phone-alt"></i>
                </div>
                <div class="permission-info">
                    <h4>Ponsel</h4>
                    <p>Untuk panggilan darurat</p>
                </div>
                <div class="permission-status waiting" id="status-phone">
                    <i class="fas fa-clock"></i>
                </div>
            </div>

            <!-- Foto dan Video -->
            <div class="permission-item" data-type="photos" data-permission="photos">
                <div class="permission-icon">
                    <i class="fas fa-images"></i>
                </div>
                <div class="permission-info">
                    <h4>Foto dan Video</h4>
                    <p>Untuk upload dan berbagi media</p>
                </div>
                <div class="permission-status waiting" id="status-photos">
                    <i class="fas fa-clock"></i>
                </div>
            </div>
        </div>

        <div class="permission-buttons">
            <button class="btn-permission" id="btnRequestPermission" onclick="checkAllPermissionsStatus()">
                <i class="fas fa-sync-alt"></i>
                <span id="btnPermissionText">Periksa Izin</span>
            </button>
            <button class="btn-settings" id="btnOpenSettings" onclick="openAppSettings()">
                <i class="fas fa-cog"></i>
                Buka Pengaturan HP
            </button>
        </div>

        <div class="permission-warning" id="permissionWarning">
            <p>
                <i class="fas fa-exclamation-triangle"></i>
                <span id="warningText">Aktifkan izin di pengaturan HP Anda</span>
            </p>
        </div>
    </div>

    <!-- Side Menu -->
    <div class="side-menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <button class="menu-close" onclick="closeMenu()"><i class="fas fa-times"></i></button>
            <div class="menu-profile">
                <img src="" alt="Avatar" class="menu-avatar" id="menuAvatar">
                <div>
                    <div class="menu-name" id="menuName">Loading...</div>
                    <div class="menu-title" id="menuTitle">-</div>
                </div>
            </div>
        </div>
        <div class="menu-items">
            <div class="menu-section">Menu Utama</div>
            <a class="menu-link" href="branda.html"><i class="fas fa-home"></i><span>Beranda</span><i class="fas fa-chevron-right arrow"></i></a>
            <a class="menu-link" href="profil.html"><i class="fas fa-user"></i><span>Profil Saya</span><i class="fas fa-chevron-right arrow"></i></a>
            <a class="menu-link" href="map.html"><i class="fas fa-map-marked-alt"></i><span>Peta Anggota</span><i class="fas fa-chevron-right arrow"></i></a>
            <a class="menu-link" href="kopdar.html"><i class="fas fa-calendar-alt"></i><span>Jadwal Kopdar</span><i class="fas fa-chevron-right arrow"></i></a>
            <a class="menu-link" href="promo.html"><i class="fas fa-tags"></i><span>Promo & Diskon</span><i class="fas fa-chevron-right arrow"></i></a>
            <a class="menu-link" href="anggota.html"><i class="fas fa-users"></i><span>Daftar Anggota</span><i class="fas fa-chevron-right arrow"></i></a>
            <div class="menu-section">Layanan</div>
            <a class="menu-link" href="pesan.html"><i class="fas fa-envelope"></i><span>Pesan</span><i class="fas fa-chevron-right arrow"></i></a>
            <a class="menu-link" href="kas.html"><i class="fas fa-wallet"></i><span>Kas & Keuangan</span><i class="fas fa-chevron-right arrow"></i></a>
            <a class="menu-link" href="jopbgtpro.html"><i class="fas fa-briefcase"></i><span>Lowongan Kerja</span><i class="fas fa-chevron-right arrow"></i></a>
            <a class="menu-link" href="riwayat.html"><i class="fas fa-history"></i><span>Riwayat</span><i class="fas fa-chevron-right arrow"></i></a>
            <div class="menu-section">Lainnya</div>
            <a class="menu-link" href="pengaturan.html"><i class="fas fa-cog"></i><span>Pengaturan</span><i class="fas fa-chevron-right arrow"></i></a>
            <a class="menu-link" href="bantuan.html"><i class="fas fa-question-circle"></i><span>Bantuan</span><i class="fas fa-chevron-right arrow"></i></a>
            <a class="menu-link" onclick="handleLogout()" style="color: var(--danger);"><i class="fas fa-sign-out-alt" style="color: var(--danger);"></i><span>Keluar</span><i class="fas fa-chevron-right arrow"></i></a>
        </div>
    </div>

    <div class="app-container" id="mainApp">

        <header class="header">
            <div class="header-left">
                <!-- MENU BURGER DIHAPUS -->
                
                <div class="header-profile" onclick="window.location.href='profil.html'">
                    <img src="" alt="Avatar" class="header-avatar" id="headerAvatar">
                    <div class="header-user-info">
                        <div class="header-name" id="headerName">Loading...</div>
                        <div class="header-status">
                            <span class="status-dot"></span>
                            <span id="headerStatusText">Online</span>
                        </div>
                    </div>
                </div>

            </div>
            <div class="header-right">
                <a href="bantuan.html" class="notif-btn" title="Bantuan">
                    <i class="fas fa-headset"></i>
                </a>
                <button class="notif-btn" onclick="window.location.href='pesan.html'"><i class="fas fa-bell"></i><span class="notif-badge hidden" id="notifBadge">0</span></button>
            </div>
        </header>

        <!-- PROMO SLIDER -->
        <div class="promo-slider-wrapper">
            <div class="promo-slider" id="promoSliderHome"></div>
        </div>

        <!-- Feature Menu -->
        <div class="feature-grid">
            <a class="feature-item" href="kopdar.html">
                <div class="feature-icon kopdar"><i class="fas fa-mug-hot"></i></div>
                <span class="feature-label">Kopdar</span>
            </a>
            <a class="feature-item" href="promo.html">
                <div class="feature-icon promo"><i class="fas fa-percent"></i></div>
                <span class="feature-label">Promo</span>
            </a>
            <a class="feature-item" href="map.html">
                <div class="feature-icon location"><i class="fas fa-map-marked-alt"></i></div>
                <span class="feature-label">Peta</span>
            </a>
            <a class="feature-item" href="pesan.html">
                <div class="feature-icon chat"><i class="fas fa-comments"></i></div>
                <span class="feature-label">Pesan</span>
            </a>
            <a class="feature-item" href="riwayat.html">
                <div class="feature-icon history"><i class="fas fa-history"></i></div>
                <span class="feature-label">Riwayat</span>
            </a>
            <a class="feature-item" href="kas.html">
                <div class="feature-icon kas"><i class="fas fa-wallet"></i></div>
                <span class="feature-label">Kas</span>
            </a>
            <a class="feature-item" href="anggota.html">
                <div class="feature-icon anggota"><i class="fas fa-users"></i></div>
                <span class="feature-label">Anggota</span>
            </a>
            <a class="feature-item" onclick="shareApp()">
                <div class="feature-icon share"><i class="fas fa-share-alt"></i></div>
                <span class="feature-label">Bagikan</span>
            </a>
        </div>

        <!-- Kopdar Section -->
        <div class="section-header">
            <h3 class="section-title"><i class="fas fa-calendar-alt"></i> Kopdar Mendatang</h3>
            <a class="section-link" href="kopdar.html">Lihat Semua</a>
        </div>
        <div class="kopdar-list" id="kopdarListHome"></div>

    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a class="nav-item nav-branda active" href="branda.html">
            <i class="fas fa-home"></i>
            <span>Beranda</span>
        </a>

        <a class="nav-item nav-kopdar" href="kopdar.html">
            <i class="fas fa-calendar-alt"></i>
            <span>Kopdar</span>
        </a>

        <a class="nav-logo" href="jopbgtpro.html">
            <img src="512B.png" alt="Logo BGT">
            <span class="nav-logo-text">Job BGT</span>
        </a>

        <a class="nav-item nav-promo" href="promo.html">
            <i class="fas fa-tags"></i>
            <span>Promo</span>
        </a>

        <a class="nav-item nav-profil" href="profil.html">
            <i class="fas fa-user"></i>
            <span>Profil</span>
        </a>
    </nav>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // ============================================
        // KEAMANAN: KONFIGURASI
        // ============================================
        const SECURITY_CONFIG = {
            SESSION_CHECK_INTERVAL: 3000,
            REQUIRE_ALL_PERMISSIONS: true
        };

        // Required Permissions List
        // webSupport: true = bisa diminta di web browser
        // webSupport: false = tidak ada di web browser (status MENUNGGU)
        const REQUIRED_PERMISSIONS = [
            { id: 'camera', name: 'Kamera', icon: 'fa-camera', webSupport: true },
            { id: 'contacts', name: 'Kontak', icon: 'fa-address-book', webSupport: false },
            { id: 'location', name: 'Lokasi', icon: 'fa-map-marker-alt', webSupport: true },
            { id: 'microphone', name: 'Mikrofon', icon: 'fa-microphone', webSupport: true },
            { id: 'notifications', name: 'Notifikasi', icon: 'fa-bell', webSupport: true },
            { id: 'bluetooth', name: 'Perangkat di Sekitar', icon: 'fa-broadcast-tower', webSupport: false },
            { id: 'phone', name: 'Ponsel', icon: 'fa-phone-alt', webSupport: false },
            { id: 'photos', name: 'Foto dan Video', icon: 'fa-images', webSupport: false }
        ];

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCahZIFKFXMCokFNxCpFokNSVtKzN4llus",
            authDomain: "cedar-setup-425414-d7.firebaseapp.com",
            databaseURL: "https://cedar-setup-425414-d7-default-rtdb.firebaseio.com",
            projectId: "cedar-setup-425414-d7",
            storageBucket: "cedar-setup-425414-d7.firebasestorage.app",
            messagingSenderId: "723545991983",
            appId: "1:723545991983:web:379548d2b425a502a60fda"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ============================================
        // KEAMANAN: STATE MANAGEMENT
        // ============================================
        let sessionUnsubscribe = null;
        let currentUserId = null;
        let localSessionId = null;
        let permissionStatus = {};

        // Sample Data
        const promoData = [
            { id: 1, title: 'Kopdar Bulanan', desc: 'Diskon 20% untuk anggota BGT!', badge: 'HOT', image: 'https://images.unsplash.com/photo-1414235077428-338989a2e8c0?w=400', gradient: 'promo-1', date: '25 Jan 2025' },
            { id: 2, title: 'Member Premium', desc: 'Fitur eksklusif untuk member!', badge: 'NEW', image: 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=400', gradient: 'promo-2', date: '01 Feb 2025' },
            { id: 3, title: 'Tour Bareng', desc: 'Jalan-jalan bersama komunitas!', badge: 'EVENT', image: 'https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?w=400', gradient: 'promo-3', date: '15 Feb 2025' },
            { id: 4, title: 'Cashback 10%', desc: 'Setiap transaksi dengan mitra BGT!', badge: 'PROMO', image: 'https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=400', gradient: 'promo-4', date: '28 Feb 2025' }
        ];

        const kopdarData = [
            { id: 1, title: 'Kopdar Bulanan Januari', date: '25 Jan 2025', time: '18:00 - 21:00', location: 'Warung Mak Beng, Sanur', image: 'https://images.unsplash.com/photo-1414235077428-338989a2e8c0?w=400', status: 'soon', attendees: 45 },
            { id: 2, title: 'Makan Malam Bersama', date: '01 Feb 2025', time: '19:00 - 22:00', location: 'Jimbaran Beach Cafe', image: 'https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400', status: 'open', attendees: 32 }
        ];

        // ============================================
        // KEAMANAN: LOCAL STORAGE FUNCTIONS
        // ============================================
        function safeSetItem(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                console.log('localStorage error:', e.message);
                return false;
            }
        }

        function safeGetItem(key) {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                return null;
            }
        }

        // ============================================
        // KEAMANAN: SESSION KICK FUNCTIONS
        // ============================================
        function showSessionKick(deviceInfo) {
            const overlay = document.getElementById('sessionKickOverlay');
            const deviceInfoEl = document.getElementById('kickDeviceInfo');
            
            if (deviceInfo) {
                deviceInfoEl.textContent = deviceInfo;
            }
            
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function handleSessionKick() {
            // Clear all session data
            localStorage.clear();
            sessionStorage.clear();
            
            // Unsubscribe from session listener
            if (sessionUnsubscribe) {
                sessionUnsubscribe();
                sessionUnsubscribe = null;
            }
            
            // Sign out from Firebase
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            }).catch(() => {
                window.location.href = 'index.html';
            });
        }

        // ============================================
        // KEAMANAN: SESSION MONITORING
        // ============================================
        function startSessionMonitor(userId) {
            currentUserId = userId;
            localSessionId = safeGetItem('userSessionId');
            
            if (sessionUnsubscribe) {
                sessionUnsubscribe();
            }
            
            // Listen to user document for session changes
            sessionUnsubscribe = db.collection('users').doc(userId).onSnapshot(
                (doc) => {
                    if (!doc.exists) {
                        handleSessionKick();
                        return;
                    }
                    
                    const data = doc.data();
                    const serverSessionId = data.currentSessionId;
                    const serverDevice = data.currentDevice;
                    
                    // If session ID changed and doesn't match local
                    if (serverSessionId && localSessionId && serverSessionId !== localSessionId) {
                        console.log('Session mismatch detected - another device logged in');
                        
                        // Stop monitoring
                        if (sessionUnsubscribe) {
                            sessionUnsubscribe();
                            sessionUnsubscribe = null;
                        }
                        
                        // Show kick notification
                        showSessionKick(serverDevice || 'Perangkat lain');
                    }
                },
                (error) => {
                    console.error('Session monitor error:', error);
                }
            );
        }

        function stopSessionMonitor() {
            if (sessionUnsubscribe) {
                sessionUnsubscribe();
                sessionUnsubscribe = null;
            }
            currentUserId = null;
        }

        // ============================================
        // KEAMANAN: PERMISSION MANAGEMENT (PRO)
        // ============================================
        
        function showPermissionOverlay() {
            const overlay = document.getElementById('permissionOverlay');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Reset all permission status - SEMUA AWALNYA MENUNGGU
            // Tidak cek status dulu karena Permissions API tidak konsisten di mobile
            permissionStatus = {};
            REQUIRED_PERMISSIONS.forEach(perm => {
                // Izin yang didukung = waiting (akan diminta saat klik tombol)
                // Izin yang tidak didukung = waiting (tetap menunggu)
                permissionStatus[perm.id] = 'waiting';
            });
            
            updatePermissionUI();
            
            // Jangan cek status otomatis - biarkan user klik tombol
            const btnText = document.getElementById('btnPermissionText');
            btnText.textContent = 'Aktifkan Semua Izin';
        }

        function hidePermissionOverlay() {
            const overlay = document.getElementById('permissionOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Check all permissions status - tidak digunakan, semua waiting dari awal
        async function checkAllPermissionsStatus() {
            const btn = document.getElementById('btnRequestPermission');
            const btnText = document.getElementById('btnPermissionText');
            
            btn.disabled = true;
            btnText.textContent = 'Memeriksa izin...';
            
            for (const perm of REQUIRED_PERMISSIONS) {
                permissionStatus[perm.id] = 'loading';
                updatePermissionUI();
                
                const status = await checkSinglePermissionStatus(perm.id);
                permissionStatus[perm.id] = status;
                updatePermissionUI();
                
                await new Promise(r => setTimeout(r, 200));
            }
            
            btn.disabled = false;
            
            // Hitung hanya izin yang DIDUKUNG web (webSupport: true)
            const supportedPerms = REQUIRED_PERMISSIONS.filter(p => p.webSupport);
            const supportedGranted = supportedPerms.filter(p => permissionStatus[p.id] === 'granted').length;
            const supportedDenied = supportedPerms.filter(p => permissionStatus[p.id] === 'denied').length;
            
            if (supportedGranted === supportedPerms.length) {
                btnText.textContent = 'Semua Izin Aktif ';
                btn.classList.add('success');
                safeSetItem('permissionsGranted', 'true');
                
                setTimeout(() => {
                    hidePermissionOverlay();
                }, 1000);
            } else if (supportedDenied > 0) {
                btnText.textContent = 'Buka Pengaturan';
                btn.classList.add('danger');
                document.getElementById('btnOpenSettings').classList.add('show');
                
                const warningEl = document.getElementById('permissionWarning');
                const warningText = document.getElementById('warningText');
                warningEl.classList.add('show');
                warningText.textContent = `${supportedDenied} izin DITOLAK. Buka pengaturan HP!`;
            } else {
                btnText.textContent = 'Periksa Ulang Izin';
            }
        }

        // Check single permission status - NON INTRUSIVE (no popup)
        // Jika izin TIDAK DIDUKUNG browser  status 'waiting' (MENUNGGU)
        // Jika izin DIDUKUNG  cek status sebenarnya
        async function checkSinglePermissionStatus(permissionId) {
            return new Promise(async (resolve) => {
                let status = 'waiting';
                
                // Cek apakah permission ini didukung di web
                const permInfo = REQUIRED_PERMISSIONS.find(p => p.id === permissionId);
                if (permInfo && !permInfo.webSupport) {
                    // Tidak didukung di web - status MENUNGGU
                    resolve('waiting');
                    return;
                }
                
                try {
                    switch (permissionId) {
                        case 'camera':
                            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                                try {
                                    if (navigator.permissions) {
                                        const result = await navigator.permissions.query({ name: 'camera' });
                                        status = result.state === 'granted' ? 'granted' : 
                                                 result.state === 'denied' ? 'denied' : 'waiting';
                                    } else {
                                        status = 'waiting';
                                    }
                                } catch (e) {
                                    status = 'waiting';
                                }
                            } else {
                                status = 'waiting';
                            }
                            break;
                            
                        case 'microphone':
                            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                                try {
                                    if (navigator.permissions) {
                                        const result = await navigator.permissions.query({ name: 'microphone' });
                                        status = result.state === 'granted' ? 'granted' : 
                                                 result.state === 'denied' ? 'denied' : 'waiting';
                                    } else {
                                        status = 'waiting';
                                    }
                                } catch (e) {
                                    status = 'waiting';
                                }
                            } else {
                                status = 'waiting';
                            }
                            break;
                        
                        case 'location':
                            if (navigator.geolocation) {
                                try {
                                    if (navigator.permissions) {
                                        const result = await navigator.permissions.query({ name: 'geolocation' });
                                        status = result.state === 'granted' ? 'granted' : 
                                                 result.state === 'denied' ? 'denied' : 'waiting';
                                    } else {
                                        status = 'waiting';
                                    }
                                } catch (e) {
                                    status = 'waiting';
                                }
                            } else {
                                status = 'waiting';
                            }
                            break;
                            
                        case 'notifications':
                            if ('Notification' in window) {
                                status = Notification.permission === 'granted' ? 'granted' : 
                                         Notification.permission === 'denied' ? 'denied' : 'waiting';
                            } else {
                                // Tidak ada Notification API - MENUNGGU
                                status = 'waiting';
                            }
                            break;
                            
                        case 'bluetooth':
                        case 'contacts':
                        case 'phone':
                        case 'photos':
                            // Izin ini tidak ada di web browser - status MENUNGGU
                            status = 'waiting';
                            break;
                            
                        default:
                            status = 'waiting';
                    }
                } catch (error) {
                    console.log(`Permission check error for ${permissionId}:`, error.message);
                    status = 'waiting';
                }
                
                resolve(status);
            });
        }
        
        // Test camera access directly
        async function testCameraAccess() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop());
                return 'granted';
            } catch (e) {
                if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
                    return 'denied';
                }
                return 'granted';
            }
        }
        
        // Test microphone access directly
        async function testMicrophoneAccess() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                return 'granted';
            } catch (e) {
                if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
                    return 'denied';
                }
                return 'granted';
            }
        }
        
        // Test location access directly
        async function testLocationAccess() {
            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    () => resolve('granted'),
                    (error) => {
                        if (error.code === error.PERMISSION_DENIED) {
                            resolve('denied');
                        } else {
                            resolve('granted');
                        }
                    },
                    { timeout: 5000, maximumAge: 60000 }
                );
            });
        }

        // Update UI
        // MENUNGGU = jam icon, DISETUJUI = centang hijau, DITOLAK = silang merah
        function updatePermissionUI() {
            let grantedCount = 0;
            let deniedCount = 0;
            
            REQUIRED_PERMISSIONS.forEach(perm => {
                const status = permissionStatus[perm.id] || 'loading';
                const statusEl = document.getElementById(`status-${perm.id}`);
                const itemEl = document.querySelector(`.permission-item[data-permission="${perm.id}"]`);
                
                if (statusEl && itemEl) {
                    statusEl.classList.remove('waiting', 'granted', 'denied', 'loading', 'not_applicable');
                    itemEl.classList.remove('granted', 'denied', 'current', 'not_supported');
                    
                    if (status === 'granted') {
                        statusEl.classList.add('granted');
                        itemEl.classList.add('granted');
                        statusEl.innerHTML = '<i class="fas fa-check"></i>';
                        grantedCount++;
                    } else if (status === 'denied') {
                        statusEl.classList.add('denied');
                        itemEl.classList.add('denied');
                        statusEl.innerHTML = '<i class="fas fa-times"></i>';
                        deniedCount++;
                    } else if (status === 'loading') {
                        statusEl.classList.add('loading');
                        itemEl.classList.add('current');
                        statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    } else {
                        // waiting atau status lain - tampilkan jam (MENUNGGU)
                        statusEl.classList.add('waiting');
                        statusEl.innerHTML = '<i class="fas fa-clock"></i>';
                    }
                }
            });
            
            // Hitung hanya izin yang didukung browser untuk progress
            const supportedPerms = REQUIRED_PERMISSIONS.filter(p => p.webSupport);
            const supportedGranted = supportedPerms.filter(p => permissionStatus[p.id] === 'granted').length;
            const percentage = (supportedGranted / supportedPerms.length) * 100;
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (progressFill) progressFill.style.width = `${percentage}%`;
            if (progressText) progressText.textContent = `${supportedGranted} dari ${supportedPerms.length} izin aktif`;
        }

        function openAppSettings() {
            const instructions = ` IZIN DITOLAK TERDETEKSI

Untuk mengaktifkan izin yang ditolak:

 ANDROID:
1. Buka Pengaturan HP
2. Cari "Aplikasi"  "Apps"
3. Cari browser ini (Chrome/Edge)
4. Ketuk "Izin"  "Permissions"
5. Aktifkan SEMUA izin yang ditolak

 iOS/iPHONE:
1. Buka Pengaturan
2. Cari browser ini (Safari/Chrome)
3. Aktifkan semua izin

 Setelah mengaktifkan, kembali dan ketuk tombol di bawah.`;
            
            alert(instructions);
            
            setTimeout(() => {
                checkAllPermissionsStatus();
            }, 1000);
        }

        // ============================================
        // REQUEST PERMISSIONS (ketika user klik tombol)
        // SELALU minta izin - jika denied, ubah ke waiting (orange) dan tetap bisa masuk
        // ============================================
        async function requestAllPermissions() {
            const btn = document.getElementById('btnRequestPermission');
            const btnText = document.getElementById('btnPermissionText');
            
            btn.disabled = true;
            
            // 1. Request Camera
            btnText.textContent = 'Meminta izin Kamera...';
            permissionStatus['camera'] = 'loading';
            updatePermissionUI();
            const cameraResult = await requestCameraPermission();
            permissionStatus['camera'] = cameraResult === 'denied' ? 'waiting' : cameraResult;
            updatePermissionUI();
            
            // 2. Request Microphone
            btnText.textContent = 'Meminta izin Mikrofon...';
            permissionStatus['microphone'] = 'loading';
            updatePermissionUI();
            const micResult = await requestMicrophonePermission();
            permissionStatus['microphone'] = micResult === 'denied' ? 'waiting' : micResult;
            updatePermissionUI();
            
            // 3. Request Location
            btnText.textContent = 'Meminta izin Lokasi...';
            permissionStatus['location'] = 'loading';
            updatePermissionUI();
            const locResult = await requestLocationPermission();
            permissionStatus['location'] = locResult === 'denied' ? 'waiting' : locResult;
            updatePermissionUI();
            
            // 4. Request Notifications
            btnText.textContent = 'Meminta izin Notifikasi...';
            permissionStatus['notifications'] = 'loading';
            updatePermissionUI();
            const notifResult = await requestNotificationPermission();
            permissionStatus['notifications'] = notifResult === 'denied' ? 'waiting' : notifResult;
            updatePermissionUI();
            
            btn.disabled = false;
            
            // SELALU IZINKAN MASUK
            btnText.textContent = 'Lanjutkan ';
            btn.classList.add('success');
            btn.classList.remove('danger');
            safeSetItem('permissionsGranted', 'true');
            
            setTimeout(() => {
                hidePermissionOverlay();
            }, 1000);
        }

        // Request functions
        async function requestCameraPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                stream.getTracks().forEach(track => track.stop());
                return 'granted';
            } catch (e) {
                if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
                    return 'denied';
                }
                return 'granted'; // Hardware error, not permission error
            }
        }

        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                return 'granted';
            } catch (e) {
                if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
                    return 'denied';
                }
                return 'granted';
            }
        }

        async function requestLocationPermission() {
            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    () => resolve('granted'),
                    (error) => {
                        if (error.code === error.PERMISSION_DENIED) {
                            resolve('denied');
                        } else {
                            resolve('granted');
                        }
                    },
                    { enableHighAccuracy: false, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        async function requestNotificationPermission() {
            if (!('Notification' in window)) return 'waiting';
            try {
                const permission = await Notification.requestPermission();
                return permission === 'granted' ? 'granted' : permission === 'denied' ? 'denied' : 'waiting';
            } catch (e) {
                return 'denied';
            }
        }

        function checkPermissionsGranted() {
            return safeGetItem('permissionsGranted') === 'true';
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function openMenu() {
            document.getElementById('sideMenu').classList.add('active');
            document.getElementById('menuOverlay').classList.add('active');
        }

        function closeMenu() {
            document.getElementById('sideMenu').classList.remove('active');
            document.getElementById('menuOverlay').classList.remove('active');
        }

        function shareApp() {
            if (navigator.share) {
                navigator.share({ title: 'BGT-PRO', text: 'Gabung komunitas PT. Bali Global Trans!', url: window.location.href });
            } else {
                showToast('info', 'Bagikan', 'Link berhasil disalin!');
            }
        }

        function showToast(type, title, message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            let iconClass = type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            let iconName = type === 'success' ? 'fa-check' : type === 'warning' ? 'fa-exclamation' : 'fa-info';
            toast.innerHTML = `
                <div class="toast-icon ${iconClass}"><i class="fas ${iconName}"></i></div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hiding'); setTimeout(() => toast.remove(), 300); }, 4000);
        }

        function loadPromoData() {
            const slider = document.getElementById('promoSliderHome');
            const allPromos = [...promoData, ...promoData];
            slider.innerHTML = allPromos.map(promo => `
                <div class="promo-card ${promo.gradient}" onclick="window.location.href='promo.html'">
                    <span class="promo-badge">${promo.badge}</span>
                    <h4 class="promo-title">${promo.title}</h4>
                    <p class="promo-desc">${promo.desc}</p>
                    <img src="${promo.image}" alt="${promo.title}" class="promo-image" loading="lazy">
                </div>
            `).join('');
        }

        function loadKopdarData() {
            const html = kopdarData.map(k => `
                <a class="kopdar-card" href="kopdar.html">
                    <img src="${k.image}" alt="${k.title}" class="kopdar-image" loading="lazy">
                    <div class="kopdar-info">
                        <h4 class="kopdar-title">${k.title}</h4>
                        <div class="kopdar-meta">
                            <span><i class="fas fa-calendar"></i> ${k.date}</span>
                            <span><i class="fas fa-clock"></i> ${k.time}</span>
                        </div>
                        <span class="kopdar-badge ${k.status}">${k.status === 'soon' ? 'Coming Soon' : 'Open Registration'}</span>
                    </div>
                </a>
            `).join('');
            document.getElementById('kopdarListHome').innerHTML = html;
        }

        function showUserData(data) {
            const avatar = data.profilePicUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.nama)}&background=6366f1&color=fff&size=200`;
            
            document.getElementById('headerAvatar').src = avatar;
            document.getElementById('headerName').textContent = data.nama || 'Pengguna';
            document.getElementById('headerStatusText').textContent = 'Online';
            
            document.getElementById('menuAvatar').src = avatar;
            document.getElementById('menuName').textContent = data.nama || '-';
            document.getElementById('menuTitle').textContent = data.titel || 'ANGGOTA';
            
            loadPromoData();
            loadKopdarData();
        }

        async function handleLogout() {
            if (!confirm('Apakah Anda yakin ingin keluar?')) return;
            try {
                localStorage.removeItem('userSessionId');
                localStorage.removeItem('permissionsGranted');
                stopSessionMonitor();
                await auth.signOut();
                window.location.href = 'index.html';
            } catch (e) { console.error(e); }
        }

        // ============================================
        // AUTH STATE LISTENER WITH SECURITY
        // ============================================
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            
            try {
                const doc = await db.collection('users').doc(user.uid).get();
                
                if (!doc.exists) {
                    await auth.signOut();
                    window.location.href = 'index.html';
                    return;
                }
                
                const data = doc.data();
                const sessionId = safeGetItem('userSessionId');
                
                // Check if session is valid
                if (data.currentSessionId && sessionId && data.currentSessionId !== sessionId) {
                    // Session mismatch - another device is logged in
                    localStorage.removeItem('userSessionId');
                    localStorage.removeItem('permissionsGranted');
                    await auth.signOut();
                    showSessionKick(data.currentDevice || 'Perangkat lain');
                    return;
                }
                
                // Start session monitoring
                startSessionMonitor(user.uid);
                
                // Show user data
                showUserData(data);
                
                // Speak welcome message (hanya sekali per session)
                const hasSpoken = sessionStorage.getItem('welcomeSpoken');
                if (!hasSpoken && data.nama) {
                    speakWelcome(data.nama);
                    sessionStorage.setItem('welcomeSpoken', 'true');
                }
                
                // Check permissions
                if (!checkPermissionsGranted()) {
                    showPermissionOverlay();
                }
                
            } catch (e) {
                console.error('Auth state error:', e);
            }
        });

        // ============================================
        // TEXT-TO-SPEECH WELCOME MESSAGE
        // ============================================
        function speakWelcome(nama) {
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                // Buat pesan sambutan
                const namaClean = nama ? nama.trim() : 'Anggota';
                const message = `Halo ${namaClean}, selamat bergabung di komunitas Bali Global Trans. Semoga hari Anda menyenangkan.`;
                
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.lang = 'id-ID';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                // Cari voice bahasa Indonesia jika ada
                const voices = window.speechSynthesis.getVoices();
                const indonesianVoice = voices.find(voice => voice.lang.includes('id'));
                if (indonesianVoice) {
                    utterance.voice = indonesianVoice;
                }
                
                window.speechSynthesis.speak(utterance);
            }
        }

        // Load voices saat halaman dimuat
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = () => {
                window.speechSynthesis.getVoices();
            };
        }
    </script>

</body>
</html>
